<!-- src/app.html -->
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<script>
			(() => {
				try {
					const LEGACY_INVERT_KEY = 'theme-invert';
					const MANUAL_MODE_KEY = 'theme-manual-mode';
					const systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
					const systemMode = systemIsDark ? 'dark' : 'light';
					const storedManualMode = sessionStorage.getItem(MANUAL_MODE_KEY);
					const manualMode =
						storedManualMode === 'dark' || storedManualMode === 'light' ? storedManualMode : null;

					// Legacy fallback: "invert=true" means "opposite of current system mode".
					const legacyInvert = sessionStorage.getItem(LEGACY_INVERT_KEY) === 'true';
					const fallbackManualMode = legacyInvert ? (systemMode === 'dark' ? 'light' : 'dark') : null;

					let normalizedManualMode = manualMode ?? fallbackManualMode;
					if (normalizedManualMode === systemMode) normalizedManualMode = null;
					const effectiveMode = normalizedManualMode ?? systemMode;
					const effectiveIsDark = effectiveMode === 'dark';

					document.documentElement.classList.toggle('dark', effectiveIsDark);
					document.documentElement.style.colorScheme = effectiveIsDark ? 'dark' : 'light';

					if (normalizedManualMode) {
						sessionStorage.setItem(MANUAL_MODE_KEY, normalizedManualMode);
					} else {
						sessionStorage.removeItem(MANUAL_MODE_KEY);
					}
					sessionStorage.setItem(LEGACY_INVERT_KEY, String(effectiveMode !== systemMode));

					// console.log('[theme init]', { systemIsDark, stored, invert, effectiveIsDark });
				} catch (e) {
					// console.log('[theme init] failed, falling back to system', e);
					const systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
					document.documentElement.classList.toggle('dark', systemIsDark);
					document.documentElement.style.colorScheme = systemIsDark ? 'dark' : 'light';
				}
			})();
		</script>

		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">%sveltekit.body%</div>
	</body>
</html>
